<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title>Hub de Controle ESP32 - Socket.IO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca Socket.IO do cliente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Corrigindo o caminho do CSS para a estrutura padrão do Flask -->
    <!-- (Flask procura 'static/css/style.css' e não '../static/css/style.css') -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-xl mx-auto rounded-xl main-card p-6 md:p-8">
        
        <!-- Cabeçalho (com usuário logado, vindo do app.py) -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 mb-1">Hub de Controle IoT</h1>
                <p class="text-gray-600">Olá, <span class="font-semibold">{{ username }}</span>!</p>
            </div>
            <a href="{{ url_for('logout') }}" class="text-sm font-medium text-blue-600 hover:text-blue-800">Sair</a>
        </div>

        <!-- 
          CONTÊINER DINÂMICO 
          O JavaScript (main.js) irá preencher esta seção com os bloquinhos
          ou com a mensagem "Nenhum microcontrolador encontrado...".
        -->
        <section id="dashboard-container" class="flex flex-col gap-6">

        
            <!-- Os bloquinhos .ESP-container serão inseridos aqui -->
        </section>
        
        <!-- Log -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-2 border-b pb-2">Log do Hub (Cliente Web)</h2>
            <div id="log-container" class="p-3 h-40 overflow-y-auto rounded-lg resize-y border border-gray-300">
                <p>Aguardando conexão...</p>
            </div>
        </div>
    </div>

    <!-- 
      Variável 'initialStatus' removida, pois não é mais necessária.
      O JavaScript agora obtém o status do evento 'full_device_update'.
    -->

    <!-- ============================
     MODAL DE AGENDAMENTO (CRUD)
     ============================ -->
    <div id="schedule-modal" class="hidden fixed inset-0 bg-white bg-opacity-40 flex justify-center items-center p-4 z-50">

        <div class="bg-white w-full max-w-2xl rounded-xl shadow-lg p-6 relative">

            <!-- Botão Fechar -->
            <button onclick="closeScheduleModal()"
                    class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-xl font-bold">
                ✕
            </button>

            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                Agendamentos
            </h2>

            <!-- Selecionar dispositivo -->
            <label class="block mb-2 text-gray-600 font-semibold">Dispositivo:</label>
            <select id="schedule-device"
                    name="device_name"
                    class="w-full mb-4 p-2 rounded border border-gray-300 bg-gray-50">
            </select>

            <!-- LISTA DE AGENDAMENTOS EXISTENTES -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Agendamentos Salvos</h3>
                <div id="schedules-list-container" class="space-y-3">
                    <!-- A lista é preenchida pelo JS -->
                </div>
            </div>

            <hr class="my-4">

            <!-- FORMULÁRIO DE NOVO AGENDAMENTO -->
            <h3 class="text-lg font-semibold text-gray-700 mb-2">
                Novo Agendamento
            </h3>

            <form id="new-schedule-form" class="space-y-4">

                <!-- Row: Escolher relé (lâmpada/cooler) -->
                <div>
                    <label class="block mb-1 text-gray-600 font-semibold">Alvo:</label>
                    <select id="schedule-target" name="target"
                            class="w-full p-2 border rounded bg-gray-50">
                        <option value="lamp">Lâmpada</option>
                        <option value="cooler">Cooler</option>
                    </select>
                </div>

                <!-- Row: Estado (ligar/desligar) -->
                <div>
                    <label class="block mb-1 text-gray-600 font-semibold">Ação:</label>
                    <select id="schedule-state" name="state"
                            class="w-full p-2 border rounded bg-gray-50">
                        <option value="on">Ligar</option>
                        <option value="off">Desligar</option>
                    </select>
                </div>

                <!-- Row: Horário -->
                <div>
                    <label class="block mb-1 text-gray-600 font-semibold">Horário:</label>
                    <input id="schedule-time" type="time" name="time"
                        class="w-full p-2 border rounded bg-gray-50"
                        required>
                </div>

                <!-- Row: Dias da semana -->
                <div>
                    <label class="block mb-1 text-gray-600 font-semibold">Dias da Semana:</label>
                    <div id="schedule-days-container" class="grid grid-cols-4 gap-2">
                        <!-- checkboxes são criados pelo JS -->
                    </div>
                </div>

                <!-- Botão salvar -->
                <button id="save-btn" type="submit" class="btn-save">
                    Adicionar Agendamento
                </button>

                <!-- Cancelar Atualização -->
                <button id="cancel-edit-btn" type="button"
                    class="w-full mt-2 text-gray-700 font-semibold py-2 rounded-lg border border-gray-300 hidden">
                    Cancelar
                </button>

                <!-- Campos ocultos -->
                <input type="hidden" name="device_name" id="hidden-device-name">

            </form>
        </div>

    </div>


    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/agendamento.js') }}"></script>
</body>
</html>